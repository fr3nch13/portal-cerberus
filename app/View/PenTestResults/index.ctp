<?php  

$allUrl = array('action' => $this->action);
if(isset($passedArgs[0]))
	$allUrl[0] = $passedArgs[0];
$page_options = array(
	'all' => $this->Html->link(__('All Results'), $allUrl, array('class' => 'tab-hijack')),
);
foreach($reportsStatuses as $reportsStatus_id => $reportsStatus_name)
{
	$page_options['ReportsStatus.'. $reportsStatus_id] = $this->Html->link(__('With Status: %s', $reportsStatus_name), array_merge($allUrl, array('field' => 'reports_status_id', 'value' => $reportsStatus_id)), array('class' => 'tab-hijack'));
}

if(isset($no_options))
	$page_options = [];

// content
$th = array(
	'PenTestResult.id' => array('content' => __('ID'), 'options' => array('sort' => 'PenTestResult.id')),
	'PenTestResult.ticket_id' => array('content' => __('Ticket ID'), 'options' => array('sort' => 'PenTestResult.ticket_id', 'editable' => array('type' => 'text') )),
	'PenTestResult.Division' => array('content' => __('Division')),
	'PenTestResult.Branch' => array('content' => __('Branch')),
	'PenTestResult.fisma_system_id' => array('content' => __('FISMA System'), 'options' => array('editable' => array('type' => 'select', 'options' => $fismaSystems) )),
	'PenTestResult.fisma_system.owner_contact_id' => array('content' => __('System Owner')),
	'PenTestResult.fisma_system.tech_poc_id' => array('content' => __('Tech POCs')),
	'PenTestResult.reports_organization_id' => array('content' => __('Organization'), 'options' => array('sort' => 'ReportsOrganization.name', 'editable' => array('type' => 'select', 'options' => $reportsOrganizations) )),
	'PenTestResult.host_description' => array('content' => __('Host Description'), 'options' => array('sort' => 'PenTestResult.host_description', 'editable' => array('type' => 'text') )),
	
	'PenTestResult.counts' => array('content' => __('# US/EOL/PT/HR')),
	'PenTestResult.ip_address' => array('content' => __('Ip Address'), 'options' => array('sort' => 'PenTestResult.ip_address', 'editable' => array('type' => 'text'))),
	'PenTestResult.host_name' => array('content' => __('Hostname'), 'options' => array('sort' => 'PenTestResult.host_name', 'editable' => array('type' => 'text'))),
	'PenTestResult.mac_address' => array('content' => __('Mac Address'), 'options' => array('sort' => 'PenTestResult.mac_address', 'editable' => array('type' => 'text'))),
	'PenTestResult.asset_tag' => array('content' => __('Asset Tag'), 'options' => array('sort' => 'PenTestResult.asset_tag', 'editable' => array('type' => 'text'))),
	'PenTestResult.netbios' => array('content' => __('NetBIOS'), 'options' => array('sort' => 'PenTestResult.netbios', 'editable' => array('type' => 'text'))),
	
	'PenTestResult.port' => array('content' => __('Port'), 'options' => array('sort' => 'PenTestResult.port', 'editable' => array('type' => 'text'))),
	'PenTestResult.service' => array('content' => __('Service'), 'options' => array('sort' => 'PenTestResult.service', 'editable' => array('type' => 'text'))),
	'PenTestResult.eol_software_id' => array('content' => __('Software/Vulnerability'), 'options' => array('sort' => 'EolSoftware.name', 'editable' => array('type' => 'select', 'options' => $eolSoftwares) )),
	'PenTestResult.software' => array('content' => __('Application'), 'options' => array('sort' => 'PenTestResult.software', 'editable' => array('type' => 'text'))),
	'PenTestResult.tickets' => array('content' => __('Tickets'), 'options' => array('sort' => 'PenTestResult.tickets', 'editable' => array('type' => 'text'))),
	'PenTestResult.waiver' => array('content' => __('Waivers'), 'options' => array('sort' => 'PenTestResult.waiver', 'editable' => array('type' => 'text'))),
	'PenTestResult.changerequest' => array('content' => __('CR IDs'), 'options' => array('sort' => 'PenTestResult.changerequest', 'editable' => array('type' => 'text'))),
	'PenTestResult.cve' => array('content' => __('CVE'), 'options' => array('sort' => 'PenTestResult.cve', 'editable' => array('type' => 'text'))),
	'PenTestResult.nessus' => array('content' => __('Nessus'), 'options' => array('sort' => 'PenTestResult.nessus')),
	'PenTestResult.reported_to_ic_date' => array('content' => __('Reported to IC'), 'options' => array('sort' => 'PenTestResult.reported_to_ic_date', 'editable' => array('type' => 'date') )),
	'PenTestResult.resolved_by_date' => array('content' => __('Must be Resolved By'), 'options' => array('sort' => 'PenTestResult.resolved_by_date', 'editable' => array('type' => 'date') )),
	'PenTestResult.reports_status_id' => array('content' => __('Status'), 'options' => array('sort' => 'ReportsStatus.name', 'editable' => array('type' => 'select', 'options' => $reportsStatuses) )),
	'PenTestResult.status_date' => array('content' => __('Status Changed Date'), 'options' => array('sort' => 'PenTestResult.status_date')),
	'PenTestResult.reports_severity_id' => array('content' => __('Severity'), 'options' => array('sort' => 'ReportsSeverity.name', 'editable' => array('type' => 'select', 'options' => $reportsSeverities) )),
	'PenTestResult.severity_date' => array('content' => __('Severity Date'), 'options' => array('sort' => 'PenTestResult.severity_date')),
	'PenTestResult.reports_assignable_party_id' => array('content' => __('Assignable Party'), 'options' => array('sort' => 'ReportsAssignableParty.name', 'editable' => array('type' => 'select', 'options' => $reportsAssignableParties) )),
	'PenTestResult.assignable_party_date' => array('content' => __('Assignable Party Date'), 'options' => array('sort' => 'PenTestResult.remediation_date')),
	'PenTestResult.reports_remediation_id' => array('content' => __('Remediation'), 'options' => array('sort' => 'ReportsRemediation.name', 'editable' => array('type' => 'select', 'options' => $reportsRemediations) )),
	'PenTestResult.remediation_date' => array('content' => __('Remediation Date'), 'options' => array('sort' => 'PenTestResult.remediation_date')),
	'PenTestResult.reports_verification_id' => array('content' => __('Verification'), 'options' => array('sort' => 'ReportsVerification.name', 'editable' => array('type' => 'select', 'options' => $reportsVerifications) )),
	'PenTestResult.verification_date' => array('content' => __('Verification Date'), 'options' => array('sort' => 'PenTestResult.verification_date')),
	'PenTestResult.action_date' => array('content' => __('Action Date'), 'options' => array('sort' => 'PenTestResult.action_date', 'editable' => array('type' => 'date') )),
	'PenTestResult.report_counts' => array('content' => __('# Reports')),
	'PenTestResult.modified' => array('content' => __('Modified'), 'options' => array('sort' => 'PenTestResult.modified' )),
	'PenTestResult.created' => array('content' => __('Created'), 'options' => array('sort' => 'PenTestResult.created' )),
	'actions' => array('content' => __('Actions'), 'options' => array('class' => 'actions')),
	'multiselect' => true,
); 

if($this->action != 'index_fisma_systems')
{
	unset($th['FismaSystems']);
}

$thresholdNow = time();
$thresholdSoon = strtotime('+10 days');
$td = array();
foreach ($pen_test_results as $i => $pen_test_result)
{
	$pen_test_result = $this->ReportResults->addFismaSystemInfo($pen_test_result);
	
	$action_date = $this->Wrap->niceTime($pen_test_result['PenTestResult']['action_date']);	
	
	$actions = array();
	$actions[] = $this->Html->link(__('View'), array('action' => 'view', $pen_test_result['PenTestResult']['id']));
	if($this->Wrap->roleCheck(array('admin', 'reviewer', 'saa')))
		$actions[] = $this->Html->link(__('Edit'), array('action' => 'edit', $pen_test_result['PenTestResult']['id']));
	if($this->Wrap->roleCheck(array('admin')))
		$actions[] = $this->Html->link(__('Delete'), array('action' => 'delete', $pen_test_result['PenTestResult']['id'], 'admin' => true));
	
	$actions = implode("", $actions);
	
	$edit_id = array(
		'PenTestResult' => $pen_test_result['PenTestResult']['id'],
	);
	
	$mclass_ip = ($pen_test_result['match_tracking']['ip_address']?'bold':false);
	$mclass_host = ($pen_test_result['match_tracking']['host_name']?'bold':false);
	$mclass_mac = ($pen_test_result['match_tracking']['mac_address']?'bold':false);
	$mclass_asset = ($pen_test_result['match_tracking']['asset_tag']?'bold':false);
	
	$highlightDueDate = false;
	$statusStyle = false;
	if(isset($pen_test_result['ReportsStatus']['name']))
	{
		if($this->Common->slugify($pen_test_result['ReportsStatus']['name']) == 'open')
		{
			$resolvedByDate = strtotime($pen_test_result['PenTestResult']['resolved_by_date']);
			if($resolvedByDate <= $thresholdNow)
				$highlightDueDate = 'highlight-red';
			elseif($resolvedByDate <= $thresholdSoon)
				$highlightDueDate = 'highlight-yellow';
		}
		else
		{
			$statusStyle = 'background-color: '.$this->Common->makeRGBfromHex($pen_test_result['ReportsStatus']['color_code_hex'], '0.3').';';
		}
	}
	
	$counts = $this->ReportResults->ajaxCountsLinks($pen_test_result['PenTestResult'], 'pen_test_result', ['prefix' => false]);
	
	
	$td[$i] = array(
		$this->Html->link($pen_test_result['PenTestResult']['id'], array('action' => 'view', $pen_test_result['PenTestResult']['id'], 'admin' => false)),
		$pen_test_result['PenTestResult']['ticket_id'],
		$pen_test_result['division_links'],
		$pen_test_result['branch_links'],
		array($pen_test_result['fisma_system_links'], array('value' => (isset($pen_test_result['PenTestResult']['fisma_system_id'])?$pen_test_result['PenTestResult']['fisma_system_id']:''))),
		$pen_test_result['owner_links'],
		$pen_test_result['techs_links'],
		array($pen_test_result['ReportsOrganization']['name'], array('value' => $pen_test_result['ReportsOrganization']['id'])),
		$pen_test_result['PenTestResult']['host_description'],
		$counts,
		array($this->Html->filterLink($pen_test_result['PenTestResult']['ip_address'], array('field' => 'ip_address', 'value' => $pen_test_result['PenTestResult']['ip_address'])), array('class' => 'nowrap '.$mclass_ip )),
		array($this->Html->filterLink($pen_test_result['PenTestResult']['host_name'], array('field' => 'host_name', 'value' => $pen_test_result['PenTestResult']['host_name'])), array('class' => 'nowrap '.$mclass_host)),
		array($pen_test_result['PenTestResult']['mac_address'], array('class' => 'nowrap '.$mclass_mac)),
		array($pen_test_result['PenTestResult']['asset_tag'], array('class' => 'nowrap '.$mclass_asset)),
		array($pen_test_result['PenTestResult']['netbios'], array('class' => 'nowrap')),
		$pen_test_result['PenTestResult']['port'],
		$pen_test_result['PenTestResult']['service'],
		array(
			(isset($pen_test_result['EolSoftware']['name'])?$this->Html->link($pen_test_result['EolSoftware']['name'], array('controller' => 'eol_softwares', 'action' => 'view', $pen_test_result['EolSoftware']['id'])):''), 
			array('class' => 'nowrap', 'value' => (isset($pen_test_result['EolSoftware']['id'])?$pen_test_result['EolSoftware']['id']:'')),
		),
		array($pen_test_result['PenTestResult']['software'], array('class' => 'nowrap')),
		array($this->Local->ticketLinks($pen_test_result['PenTestResult']['tickets']), array('class' => 'nowrap')),
		array($this->Local->waiverLinks($pen_test_result['PenTestResult']['waiver']), array('class' => 'nowrap')),
		array($this->Local->crLinks($pen_test_result['PenTestResult']['changerequest']), array('class' => 'nowrap')),
		array($pen_test_result['PenTestResult']['cve'], array('class' => 'nowrap')),
		$this->Common->yesNo($pen_test_result['PenTestResult']['nessus']),
		array(
			$this->Wrap->niceDay($pen_test_result['PenTestResult']['reported_to_ic_date']),
			array('value' => $pen_test_result['PenTestResult']['reported_to_ic_date']),
		),
		array(
			$this->Wrap->niceDay($pen_test_result['PenTestResult']['resolved_by_date']),
			array('value' => $pen_test_result['PenTestResult']['resolved_by_date'], 'class' => $highlightDueDate),
		),
		array(($pen_test_result['ReportsStatus']['name']?$pen_test_result['ReportsStatus']['name']:'&nbsp;'), array('class' => 'nowrap', 'value' => $pen_test_result['PenTestResult']['reports_status_id'], 'data-style' => $statusStyle)),
		array($this->Wrap->niceDay($pen_test_result['PenTestResult']['status_date']), array('class' => 'nowrap')),
		array(($pen_test_result['ReportsSeverity']['name']?$pen_test_result['ReportsSeverity']['name']:'&nbsp;'), array('class' => 'nowrap', 'value' => $pen_test_result['PenTestResult']['reports_severity_id'])),
		array($this->Wrap->niceDay($pen_test_result['PenTestResult']['severity_date']), array('class' => 'nowrap')),
		array(($pen_test_result['ReportsAssignableParty']['name']?$pen_test_result['ReportsAssignableParty']['name']:'&nbsp;'), array('class' => 'nowrap', 'value' => $pen_test_result['PenTestResult']['reports_assignable_party_id'])),
		array($this->Wrap->niceDay($pen_test_result['PenTestResult']['assignable_party_date']), array('class' => 'nowrap')),
		array(($pen_test_result['ReportsRemediation']['name']?$pen_test_result['ReportsRemediation']['name']:'&nbsp;'), array('class' => 'nowrap', 'value' => $pen_test_result['PenTestResult']['reports_remediation_id'])),
		array($this->Wrap->niceDay($pen_test_result['PenTestResult']['remediation_date']), array('class' => 'nowrap')),
		array(($pen_test_result['ReportsVerification']['name']?$pen_test_result['ReportsVerification']['name']:'&nbsp;'), array('class' => 'nowrap', 'value' => $pen_test_result['PenTestResult']['reports_verification_id'])),
		array($this->Wrap->niceDay($pen_test_result['PenTestResult']['verification_date']), array('class' => 'nowrap')),
		array($this->Wrap->niceDay($pen_test_result['PenTestResult']['action_date']), array('class' => 'nowrap', 'value' => $pen_test_result['PenTestResult']['action_date'])),
		array('.', array(
			'ajax_count_url' => array('controller' => 'pen_test_reports', 'action' => 'pen_test_result', $pen_test_result['PenTestResult']['id'], 'admin' => false),
			'url' => array('action' => 'view', $pen_test_result['PenTestResult']['id'], 'tab' => 'pen_test_reports', 'admin' => false),
		)),
		array($this->Wrap->niceTime($pen_test_result['PenTestResult']['modified']), array('class' => 'nowrap')),
		array($this->Wrap->niceTime($pen_test_result['PenTestResult']['created']), array('class' => 'nowrap')),
		array(
			$actions,
			array('class' => 'actions'),
		),
		'multiselect' => $pen_test_result['PenTestResult']['id'],
		'edit_id' => $edit_id,
	);
	
	if($this->action != 'index_fisma_systems')
	{
		unset($td[$i]['FismaSystems']);
	}
}

$use_gridedit = false;
$use_griddelete = $user_gridadd = false;
if($this->Wrap->roleCheck(array('admin', 'reviewer', 'saa')))
	$use_gridedit = true;
if($this->Wrap->roleCheck(array('admin')))
	$use_griddelete = $user_gridadd = true;

foreach($multiselectOptions as $ms_key => $ms_name)
{
	$multiselectOptions[$ms_key] = __('Set all selected %s to one %s', __('Pen Test Results'), $ms_name);
}

echo $this->element('Utilities.page_index', array(
	'page_title' => __('Pen Test Results'),
	'page_subtitle' => (isset($page_subtitle)?$page_subtitle:false),
	'page_description' => $page_description,
	'page_options_title' => __('View By %s', __('Status')),
	'page_options' => $page_options,
	'th' => $th,
	'td' => $td,
	'table_caption' => __('Highlights - Red: Open/past resolved by date - Yellow: Open/resolved by date within 10 days from now.<br/>%s with a &dagger; next to them have been manually chosen', __('FISMA Systems')),
	'table_widget_options' => array(
		'setup' => "
			self.element.find('td.highlight-red').parents('tr').addClass('highlight-red');
			self.element.find('td.highlight-yellow').parents('tr').addClass('highlight-yellow');
			self.element.find('td[data-style]').each(function(){ $(this).parents('tr').attr('style', $(this).data('style')) });
		"
	),
	// grid/inline edit options
	'use_gridedit' => $use_gridedit,
//	'use_gridadd' => $user_gridadd,
	'use_griddelete' => $use_griddelete,
	'use_multiselect' => true,
	'multiselect_options' => $multiselectOptions,
));