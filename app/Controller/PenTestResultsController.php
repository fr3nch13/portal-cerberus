<?php
App::uses('AppController', 'Controller');

class PenTestResultsController extends AppController 
{
	public $cacheAction = array(
	    'db_block_overview' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true),
		'db_block_assignable_party_trend' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true),
		'db_block_remediation_trend' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true),
		'db_block_severity_trend' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true),
		'db_block_status_trend' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true),
		'db_block_verification_trend' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true),
		
	    'db_tab_index' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true),
//		'db_tab_status_change' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true),
		'db_tab_gssparent' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true),
		
		'db_tab_totals' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true, 'urls' => array(array('org', 1, 0), array('division', 1, 0), array('system', 2)) ),
		'db_tab_assignable_party' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true, 'urls' => array(array('org', 1, 0), array('division', 1, 0)) ),
		'db_tab_remediation' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true, 'urls' => array(array('org', 1, 0), array('division', 1, 0)) ),
		'db_tab_severity' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true, 'urls' => array(array('org', 1, 0), array('division', 1, 0)) ),
		'db_tab_status' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true, 'urls' => array(array('org', 1, 0), array('division', 1, 0)) ),
		'db_tab_verification' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true, 'urls' => array(array('org', 1, 0), array('division', 1, 0)) ),
		
		'db_tab_breakout' => array('callbacks' => true, 'duration' => '1 day', 'recache' => true),
	);
	
	public $subscriptions = [
		'isso_open_counts',
	];
	
	public function menu_assignable_parties() 
	{
		if (!$this->request->is('requested')) 
		{
			throw new NotFoundException(__('Invalid %s', __('Request')));
		}
			
		// format for the menu_items
		$items = array();
		$this->PenTestResult->ReportsAssignableParty->typeFormListOrder = array('name' => 'ASC');
		$reportsAssignableParties = $this->PenTestResult->ReportsAssignableParty->typeFormList();
		
		foreach($reportsAssignableParties as $reportsAssignableParty_id => $reportsAssignableParty_name)
		{
			$title = $reportsAssignableParty_name;
			
			$items[] = array(
				'title' => $title,
				'url' => array('controller' => 'pen_test_results', 'action' => 'index', 'field' => 'reports_assignable_party_id', 'value' => $reportsAssignableParty_id, 'admin' => false, 'saa' => false, 'plugin' => false)
			);
		}
		return $items;
	}
	
	public function menu_remediations() 
	{
		if (!$this->request->is('requested')) 
		{
			throw new NotFoundException(__('Invalid %s', __('Request')));
		}
			
		// format for the menu_items
		$items = array();
		$this->PenTestResult->ReportsRemediation->typeFormListOrder = array('name' => 'ASC');
		$reportsRemediations = $this->PenTestResult->ReportsRemediation->typeFormList();
		
		foreach($reportsRemediations as $reportsRemediation_id => $reportsRemediation_name)
		{
			$title = $reportsRemediation_name;
			
			$items[] = array(
				'title' => $title,
				'url' => array('controller' => 'pen_test_results', 'action' => 'index', 'field' => 'reports_remediation_id', 'value' => $reportsRemediation_id, 'admin' => false, 'saa' => false, 'plugin' => false)
			);
		}
		return $items;
	}
	
	public function menu_verifications() 
	{
		if (!$this->request->is('requested')) 
		{
			throw new NotFoundException(__('Invalid %s', __('Request')));
		}
			
		// format for the menu_items
		$items = array();
		$this->PenTestResult->ReportsVerification->typeFormListOrder = array('name' => 'ASC');
		$reportsVerifications = $this->PenTestResult->ReportsVerification->typeFormList();
		
		foreach($reportsVerifications as $reportsVerification_id => $reportsVerification_name)
		{
			$title = $reportsVerification_name;
			
			$items[] = array(
				'title' => $title,
				'url' => array('controller' => 'pen_test_results', 'action' => 'index', 'field' => 'reports_verification_id', 'value' => $reportsVerification_id, 'admin' => false, 'saa' => false, 'plugin' => false)
			);
		}
		return $items;
	}
	
	public function menu_statuses() 
	{
		if (!$this->request->is('requested')) 
		{
			throw new NotFoundException(__('Invalid %s', __('Request')));
		}
			
		// format for the menu_items
		$items = array();
		$this->PenTestResult->ReportsStatus->typeFormListOrder = array('name' => 'ASC');
		$reportsStatuses = $this->PenTestResult->ReportsStatus->typeFormList();
		
		foreach($reportsStatuses as $reportsStatus_id => $reportsStatus_name)
		{
			$title = $reportsStatus_name;
			
			$items[] = array(
				'title' => $title,
				'url' => array('controller' => 'pen_test_results', 'action' => 'index', 'field' => 'reports_status_id', 'value' => $reportsStatus_id, 'admin' => false, 'saa' => false, 'plugin' => false)
			);
		}
		return $items;
	}
	
	public function menu_severities() 
	{
		if (!$this->request->is('requested')) 
		{
			throw new NotFoundException(__('Invalid %s', __('Request')));
		}
			
		// format for the menu_items
		$items = array();
		$this->PenTestResult->ReportsSeverity->typeFormListOrder = array('name' => 'ASC');
		$reportsSeverities = $this->PenTestResult->ReportsSeverity->typeFormList();
		
		foreach($reportsSeverities as $reportsSeverity_id => $reportsSeverity_name)
		{
			$title = $reportsSeverity_name;
			
			$items[] = array(
				'title' => $title,
				'url' => array('controller' => 'pen_test_results', 'action' => 'index', 'field' => 'reports_severity_id', 'value' => $reportsSeverity_id, 'admin' => false, 'saa' => false, 'plugin' => false)
			);
		}
		return $items;
	}
	
	public function crm_actionable($fisma_system_id = false, $crm_id = false)
	{
		$crm = $this->PenTestResult->FismaSystem->getCrm($crm_id);
		$crm_id = $crm['AdAccount']['id'];
		$this->set('crm', $crm);
		$this->set('crm_id', $crm_id);
		
		$conditions = array();
		
		$reportsStatuses = $this->PenTestResult->ReportsStatus->findforTable(true);
		$reportsStatus_ids = Hash::extract($reportsStatuses, '{n}.ReportsStatus.id');
		
		$conditions['PenTestResult.reports_status_id'] = $reportsStatus_ids;
		
		if($fisma_system_id)
		{
			if (!$fisma_system = $this->PenTestResult->FismaSystem->read(null, $fisma_system_id))
			{
				throw new NotFoundException(__('Invalid %s', __('FISMA System')));
			}
			$this->set('fisma_system', $fisma_system);
			
			if(!$scopedConditions = $this->PenTestResult->conditionsforFismaSystem($fisma_system_id))
			{
				$this->paginate['empty'] = true;
			}
		
			$conditions = array_merge($conditions, $scopedConditions);
		}
		
		$this->paginate['conditions'] = $this->PenTestResult->conditions($conditions, $this->passedArgs); 
		
		$this->PenTestResult->recursive = 0;
		$this->paginate['limit'] = $this->paginate['maxLimit'] = $this->PenTestResult->find('count', array('conditions' => $this->paginate['conditions']));
		if($this->paginate['limit'])
			$pen_test_results = $this->paginate();
		else
			$pen_test_results = array();
		return $pen_test_results;
	}
	
	public function owner_actionable($fisma_system_id = false, $owner_id = false)
	{
		$owner = array();
		if($owner_id)
			$owner = $this->PenTestResult->FismaSystem->getOwner($owner_id);
		$owner_id = $owner['AdAccount']['id'];
		$this->set('owner', $owner);
		$this->set('owner_id', $owner_id);
		
		$conditions = array();
		
		$reportsStatuses = $this->PenTestResult->ReportsStatus->findforTable(true);
		$reportsStatus_ids = Hash::extract($reportsStatuses, '{n}.ReportsStatus.id');
		
		$conditions['PenTestResult.reports_status_id'] = $reportsStatus_ids;
		
		if($fisma_system_id)
		{
			if (!$fisma_system = $this->PenTestResult->FismaSystem->read(null, $fisma_system_id))
			{
				throw new NotFoundException(__('Invalid %s', __('FISMA System')));
			}
			$this->set('fisma_system', $fisma_system);
			
			if(!$scopedConditions = $this->PenTestResult->conditionsforFismaSystem($fisma_system_id))
			{
				$this->paginate['empty'] = true;
			}
		
			$conditions = array_merge($conditions, $scopedConditions);
		}
		
		$this->paginate['conditions'] = $this->PenTestResult->conditions($conditions, $this->passedArgs); 
		
		$this->PenTestResult->recursive = 0;
		$this->paginate['limit'] = $this->paginate['maxLimit'] = $this->PenTestResult->find('count', array('conditions' => $this->paginate['conditions']));
		if($this->paginate['limit'])
			$pen_test_results = $this->paginate();
		else
			$pen_test_results = array();
		return $pen_test_results;
	}
	
	public function director_db_block_overview($ad_account_id = false)
	{
		if(!$ad_account_id)
			$ad_account_id = AuthComponent::user('ad_account_id');
		$this->set('ad_account_id', $ad_account_id);
		
		$penTestResults = $this->PenTestResult->listforDirector($ad_account_id, 'all', array('recursive' => 0));
		
		$penTestResults = $this->PenTestResult->dbOverviewUpdate($penTestResults);
		
		$reportsSeverities = $this->PenTestResult->ReportsSeverity->typeFormList();
		$reportsStatuses = $this->PenTestResult->ReportsStatus->typeFormList();
		$this->set(compact('penTestResults', 'reportsStatuses', 'reportsSeverities'));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function director_db_tab_index($ad_account_id = false, $stripped = false)
	{
		if(!$ad_account_id)
			$ad_account_id = AuthComponent::user('ad_account_id');
		$this->set('ad_account_id', $ad_account_id);
		
		if(!$this->conditions = $this->PenTestResult->listforDirector($ad_account_id, 'conditions'))
		{
			$this->paginate['empty'] = true;
		}
		
		return $this->db_tab_index($stripped);
	}
	
/* track down where this is used */
// BBBBB Needs a ReportsResultsBehavior Solution
	public function db_block_fisma_systems($by_division = false)
	{
		$this->Prg->commonProcess();
		
		$conditions = array();
		
		// get the result ids for this event
		if($penTestResult_ids = $this->PenTestResult->getIdsForEvent())
			$conditions['PenTestResult.id'] = $penTestResult_ids;
		
		$penTestResults = $this->PenTestResult->find('all', array(
			'recursive' => 0,
			'conditions' => $conditions,
		));
		
		$this->paginate['conditions'] = $this->PenTestResult->conditions($conditions, $this->passedArgs); 
		
		$this->PenTestResult->recursive = 0;
		$this->paginate['order'] = array('PenTestResult.created' => 'desc');
		
		$penTestResults = $this->paginate();
		
		foreach($penTestResults as $i => $penTestResult)
		{
			$penTestResult_conditions = array('OR' => array());
			
			if($penTestResult['PenTestResult']['ip_address'])
				$penTestResult_conditions['OR'][] = array(
					'FismaInventory.ip_address !=' => '',
					'FismaInventory.ip_address' => $penTestResult['PenTestResult']['ip_address'],
				);
			if($penTestResult['PenTestResult']['host_name'])
				$penTestResult_conditions['OR'][] = array(
					'FismaInventory.dns_name !=' => '',
					'FismaInventory.dns_name' => $penTestResult['PenTestResult']['host_name'],
				);
			if($penTestResult['PenTestResult']['mac_address'])
				$penTestResult_conditions['OR'][] = array(
					'FismaInventory.mac_address !=' => '',
					'FismaInventory.mac_address' => $penTestResult['PenTestResult']['mac_address'],
				);
			if($penTestResult['PenTestResult']['asset_tag'])
				$penTestResult_conditions['OR'][] = array(
					'FismaInventory.asset_tag !=' => '',
					'FismaInventory.asset_tag' => $penTestResult['PenTestResult']['asset_tag'],
				);
			
			$penTestResults[$i]['FismaSystems'] = $this->PenTestResult->SubnetMember->FismaInventory->find('all', array(
				'recursive' => 0,
				'conditions' => $penTestResult_conditions,
				'contain' => array('FismaSystem.OwnerContact', 'FismaSystem.OwnerContact.Division'),
			));
			
		}
		
		$reportsSeverities = $this->PenTestResult->ReportsSeverity->typeFormList();
		$reportsStatuses = $this->PenTestResult->ReportsStatus->typeFormList();
		
		$this->set(compact(array('penTestResults', 'reportsSeverities', 'reportsStatuses')));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_block_overview($reports_event_id = false)
	{
		$penTestResults = array();
		$conditions = array();
		$empty = false;
		
		// get the result ids for this event
		if($reports_event_id)
		{
			if($penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id))
			{
				$conditions['PenTestResult.id'] = $penTestResult_ids;
			}
			else
			{
				$empty = true;
			}
		}
		
		if(!$empty)
		{
			$penTestResults = $this->PenTestResult->find('all', array('contain' => array('ReportsStatus', 'ReportsSeverity'), 'conditions' => $conditions));
		}
		
		$reportsSeverities = $this->PenTestResult->ReportsSeverity->typeFormList();
		$reportsStatuses = $this->PenTestResult->ReportsStatus->typeFormList();
		$this->set(compact(array('reportsSeverities', 'reportsStatuses')));
		
		foreach($penTestResults as $i => $penTestResult)
		{
			$penTestResults[$i] = $this->PenTestResult->attachFismaSystem($penTestResult);
		}
		
		$this->set(compact('penTestResults', 'reports_event_id'));
		
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_tab_totals($scope = 'org', $as_block = false, $reports_event_id = false)
	{
		$results = array();
		$conditions = array();
		$empty = false;
		
		// get the result ids for this event
		if($reports_event_id)
		{
			if($penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id))
			{
				$conditions['PenTestResult.id'] = $penTestResult_ids;
			}
			else
			{
				$empty = true;
			}
		}
		
		if(isset($this->passedArgs['reports_status_id']) and $this->passedArgs['reports_status_id'])
			$conditions['PenTestResult.reports_status_id'] = $this->passedArgs['reports_status_id'];
		
		if(!$empty)
		{
			$results = $this->scopedResults($scope, $conditions);
		}
		
		$reportsStatuses = $this->PenTestResult->ReportsStatus->find('all');
		
		$this->set(compact(array(
			'as_block', 'results', 'reports_event_id',
			'reportsStatuses',
			
		)));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_tab_gssparent($reports_event_id = false)
	{
		
		$fismaSystems = array();
		$conditionsPenTestResult = array();
		$empty = false;
		
		// get the result ids for this event
		if($reports_event_id)
		{
			if($penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id))
			{
				$conditionsPenTestResult['PenTestResult.id'] = $penTestResult_ids;
			}
			else
			{
				$empty = true;
			}
		}
		
		if(!$empty)
		{
			$fismaSystems = $this->PenTestResult->FismaSystem->find('AllParents', array(
				'order' => array('FismaSystem.name' => 'ASC'),
			));
		}
		
		foreach($fismaSystems as $i => $fismaSystem)
		{
			// get the children
			$this->PenTestResult->FismaSystem->id = $fismaSystem['FismaSystem']['id'];
			$fismaSystemChildren = $this->PenTestResult->FismaSystem->find('MyChildren');
			
			$fismaSystemIds = array($fismaSystem['FismaSystem']['id'] => $fismaSystem['FismaSystem']['id']);
			
			// get the children related vectors
			foreach($fismaSystemChildren as $j => $fismaSystemChild)
			{
				$fismaSystemIds[$fismaSystemChild['FismaSystem']['id']] = $fismaSystemChild['FismaSystem']['id'];
			}
			
			$resultConditions = $this->PenTestResult->conditionsforFismaSystem($fismaSystemIds);
			
			if(!isset($resultConditions['OR']))
			{
				unset($fismaSystems[$i]);
				continue;
			}
			
			$conditionsPenTestResult = array_merge($conditionsPenTestResult, $resultConditions);
			
			if(!$penTestResults = $this->PenTestResult->find('all', array(
				'conditions' => $conditionsPenTestResult,
			)))
			{
				unset($fismaSystems[$i]);
				continue;
			}
			
			$fismaSystems[$i]['PenTestResults'] = $penTestResults;
		}
		
		$this->set(compact(array(
			'fismaSystems', 'reports_event_id',
		)));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_block_assignable_party_trend($reports_event_id = false)
	{
		$reportsEvent = [];
		$regex = '/^pen_test_result\.reports_assignable_party\-\d+$/';
		if($reports_event_id)
		{
			$regex = '/^pen_test_result\.reports_event-'.$reports_event_id.'\.reports_assignable_party\-\d+$/';
			$reportsEvent = $this->PenTestResult->PenTestReport->ReportsEvent->read(null, $reports_event_id);
		}
		$snapshotStats = $this->PenTestResult->snapshotDashboardGetStats($regex);
		
		$reportsAssignableParties = $this->PenTestResult->ReportsAssignableParty->find('list', [
			'fields' => ['ReportsAssignableParty.id', 'ReportsAssignableParty.color_code_hex'],
		]);
		
		$this->set(compact('snapshotStats', 'reportsAssignableParties', 'reportsEvent'));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_block_remediation_trend($reports_event_id = false)
	{
		$reportsEvent = [];
		$regex = '/^pen_test_result\.reports_remediation\-\d+$/';
		if($reports_event_id)
		{
			$regex = '/^pen_test_result\.reports_event-'.$reports_event_id.'\.reports_remediation\-\d+$/';
			$reportsEvent = $this->PenTestResult->PenTestReport->ReportsEvent->read(null, $reports_event_id);
		}
		$snapshotStats = $this->PenTestResult->snapshotDashboardGetStats($regex);
		
		$reportsRemediations = $this->PenTestResult->ReportsRemediation->find('list', [
			'fields' => ['ReportsRemediation.id', 'ReportsRemediation.color_code_hex'],
		]);
		
		$this->set(compact('snapshotStats', 'reportsRemediations', 'reportsEvent'));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_block_severity_trend($reports_event_id = false)
	{
		$reportsEvent = [];
		$regex = '/^pen_test_result\.reports_severity\-\d+$/';
		if($reports_event_id)
		{
			$regex = '/^pen_test_result\.reports_event-'.$reports_event_id.'\.reports_severity\-\d+$/';
			$reportsEvent = $this->PenTestResult->PenTestReport->ReportsEvent->read(null, $reports_event_id);
		}
		
		$snapshotStats = $this->PenTestResult->snapshotDashboardGetStats($regex);
		
		$reportsSeverities = $this->PenTestResult->ReportsSeverity->find('list', [
			'fields' => ['ReportsSeverity.id', 'ReportsSeverity.color_code_hex'],
		]);
		
		$this->set(compact('snapshotStats', 'reportsSeverities', 'reportsEvent'));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_block_status_trend($reports_event_id = false)
	{
		$reportsEvent = [];
		$regex = '/^pen_test_result\.reports_status\-\d+$/';
		if($reports_event_id)
		{
			$regex = '/^pen_test_result\.reports_event-'.$reports_event_id.'\.reports_status\-\d+$/';
			$reportsEvent = $this->PenTestResult->PenTestReport->ReportsEvent->read(null, $reports_event_id);
		}
		
		$snapshotStats = $this->PenTestResult->snapshotDashboardGetStats($regex);
		
		$reportsStatuses = $this->PenTestResult->ReportsStatus->find('list', [
			'fields' => ['ReportsStatus.id', 'ReportsStatus.color_code_hex'],
		]);
		
		$this->set(compact('snapshotStats', 'reportsStatuses', 'reportsEvent'));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_block_verification_trend($reports_event_id = false)
	{
		$reportsEvent = [];
		$regex = '/^pen_test_result\.reports_verification\-\d+$/';
		if($reports_event_id)
		{
			$regex = '/^pen_test_result\.reports_event-'.$reports_event_id.'\.reports_verification\-\d+$/';
			$reportsEvent = $this->PenTestResult->PenTestReport->ReportsEvent->read(null, $reports_event_id);
		}
		
		$snapshotStats = $this->PenTestResult->snapshotDashboardGetStats($regex);
		
		$reportsVerifications = $this->PenTestResult->ReportsVerification->find('list', [
			'fields' => ['ReportsVerification.id', 'ReportsVerification.color_code_hex'],
		]);
		
		$this->set(compact('snapshotStats', 'reportsVerifications', 'reportsEvent'));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_block_severity($reports_severity_id = false, $reports_event_id = false)
	{	
		$conditions = array(
			'PenTestResult.reports_severity_id' => $reports_severity_id,
		);
		
		$penTestResults = array();
		$empty = false;
		
		// get the result ids for this event
		if($reports_event_id)
		{
			if($penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id))
			{
				$conditions['PenTestResult.id'] = $penTestResult_ids;
			}
			else
			{
				$empty = true;
			}
		}
		
		if(!$empty)
		{
			$penTestResults = $this->PenTestResult->find('all', array(
				'recursive' => 0,
				'conditions' => $conditions,
			));
		}
		
		$reportsSeverity = $this->PenTestResult->ReportsSeverity->read(null, $reports_severity_id);
		$reportsStatuses = $this->PenTestResult->ReportsStatus->typeFormList();
		
		$this->set(compact('reportsSeverity', 'reportsStatuses', 'penTestResults', 'reports_event_id'));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_tab_index($stripped = false, $reports_event_id = false)
	{
		$this->Prg->commonProcess();
		
		$conditions = array();
		$empty = false;
		
		// get the result ids for this event
		if($reports_event_id)
		{
			if($penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id))
			{
				$conditions['PenTestResult.id'] = $penTestResult_ids;
			}
			else
			{
				$empty = true;
			}
		}
		
		if($empty)
		{
			$this->paginate['empty'] = true;
		}
		
		if(isset($this->passedArgs['reports_status_id']) and $this->passedArgs['reports_status_id'])
			$conditions['PenTestResult.reports_status_id'] = $this->passedArgs['reports_status_id'];
		$conditions = array_merge($conditions, $this->conditions);
		
		$this->paginate['conditions'] = $this->PenTestResult->conditions($conditions, $this->passedArgs); 
		
		$this->PenTestResult->recursive = 0;
		
		if(!isset($this->paginateModel))
			$this->paginateModel = 'PenTestResult';
		
		if($stripped)
		{
			$this->paginate['limit'] = $this->paginate['maxLimit'] = $this->PenTestResult->getCachedCounts('count', array('conditions' => $this->paginate['conditions']));
			if(!$this->paginate['limit'])
				$this->paginate['empty'] = true;
		}
		
		$pen_test_results = $this->paginate($this->paginateModel);
		
		foreach($pen_test_results as $i => $pen_test_result)
		{
			$pen_test_results[$i] = $this->PenTestResult->attachFismaSystem($pen_test_result);
		}
		
		$this->set(compact('pen_test_results', 'reports_event_id'));
		$this->set('stripped', $stripped);
		
		$this->layout = 'Utilities.ajax_nodebug';
		return $this->render('db_tab_index');
	}
	
	public function db_tab_breakout($scope = 'org', $as_block = false, $reports_event_id = false)
	{
		$results = array();
		$conditions = array();
		
		$reportsStatusOpenId = $this->PenTestResult->ReportsStatus->getOpenId();
		
		$reportsStatusName = __('All');
		$reportsStatusId = 0;
		if(isset($this->passedArgs['reports_status_id']))
		{
			if($this->passedArgs['reports_status_id'])
			{
				$conditions['PenTestResult.reports_status_id']  = $this->passedArgs['reports_status_id'];
				$reportsStatusName = __('Status: %s', $this->PenTestResult->ReportsStatus->field('name', array('ReportsStatus.id' => $this->passedArgs['reports_status_id'])));
				$reportsStatusId = $this->passedArgs['reports_status_id'];
			}
		}
		else
		{
			$conditions['PenTestResult.reports_status_id'] = $reportsStatusOpenId;
			$reportsStatusName = __('Status: %s', __('Open'));
			$reportsStatusId = $reportsStatusOpenId;
		}
		
		$empty = false;
		
		// get the result ids for this event
		if($reports_event_id)
		{
			if($penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id))
			{
				$conditions['PenTestResult.id'] = $penTestResult_ids;
			}
			else
			{
				$empty = true;
			}
		}
		
		if(!$empty)
		{
			$results = $this->scopedResults($scope, $conditions);
		}
		
		$reportsStatuses = $this->PenTestResult->ReportsStatus->typeFormList();
		$this->set(compact(array(
			'as_block', 'results', 'reports_event_id', 'scope', 
			'reportsStatusOpenId', 'reportsStatusId', 'reportsStatusName', 'reportsStatuses',
		)));
//		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_tab_assignable_party($scope = 'org', $as_block = false, $reports_event_id = false)
	{
		$results = array();
		$conditions = array();
		$empty = false;
		
		// get the result ids for this event
		if($reports_event_id)
		{
			if($penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id))
			{
				$conditions['PenTestResult.id'] = $penTestResult_ids;
			}
			else
			{
				$empty = true;
			}
		}
		
		if(!$empty)
		{
			$results = $this->scopedResults($scope, $conditions);
		}
		
		$reportsAssignableParties = $this->PenTestResult->ReportsAssignableParty->typeFormList();
		
		$this->set(compact(array(
			'as_block', 'results', 'reports_event_id',
			'reportsAssignableParties',
		)));
		$this->layout = 'Utilities.ajax_nodebug';
		
	}
	
	public function db_tab_remediation($scope = 'org', $as_block = false, $reports_event_id = false)
	{
		$results = array();
		$conditions = array();
		$empty = false;
		
		// get the result ids for this event
		if($reports_event_id)
		{
			if($penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id))
			{
				$conditions['PenTestResult.id'] = $penTestResult_ids;
			}
			else
			{
				$empty = true;
			}
		}
		
		if(!$empty)
		{
			$results = $this->scopedResults($scope, $conditions);
		}
		
		$reportsRemediations = $this->PenTestResult->ReportsRemediation->typeFormList();
		
		$this->set(compact(array(
			'as_block', 'results', 'reports_event_id',
			'reportsRemediations',
		)));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_tab_severity($scope = 'org', $as_block = false, $reports_event_id = false)
	{
		$results = array();
		$conditions = array();
		$empty = false;
		
		// get the result ids for this event
		if($reports_event_id)
		{
			if($penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id))
			{
				$conditions['PenTestResult.id'] = $penTestResult_ids;
			}
			else
			{
				$empty = true;
			}
		}
		
		if(!$empty)
		{
			$results = $this->scopedResults($scope, $conditions);
		}
		
		$reportsSeverities = $this->PenTestResult->ReportsSeverity->find('all');
		
		$this->set(compact(array(
			'as_block', 'results', 'reports_event_id',
			'reportsSeverities',
		)));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_tab_status($scope = 'org', $as_block = false, $reports_event_id = false)
	{
		$results = array();
		$conditions = array();
		$empty = false;
		
		// get the result ids for this event
		if($reports_event_id)
		{
			if($penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id))
			{
				$conditions['PenTestResult.id'] = $penTestResult_ids;
			}
			else
			{
				$empty = true;
			}
		}
		
		if(!$empty)
		{
			$results = $this->scopedResults($scope, $conditions);
		}
		
		$reportsStatuses = $this->PenTestResult->ReportsStatus->find('all');
		
		$this->set(compact(array(
			'as_block', 'results', 'reports_event_id',
			'reportsStatuses',
		)));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_tab_verification($scope = 'org', $as_block = false, $reports_event_id = false)
	{
		$results = array();
		$conditions = array();
		$empty = false;
		
		// get the result ids for this event
		if($reports_event_id)
		{
			if($penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id))
			{
				$conditions['PenTestResult.id'] = $penTestResult_ids;
			}
			else
			{
				$empty = true;
			}
		}
		
		if(!$empty)
		{
			$results = $this->scopedResults($scope, $conditions);
		}
		
		$reportsVerifications = $this->PenTestResult->ReportsVerification->typeFormList();
		
		$this->set(compact(array(
			'as_block', 'results', 'reports_event_id',
			'reportsVerifications',
		)));
		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_tab_crossovers($scope = 'org', $as_block = false, $reports_event_id = false)
	{
		$results = array();
		$conditions = array();
		$empty = false;
		
		// get the result ids for this event
		if($reports_event_id)
		{
			if($penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id))
			{
				$conditions['PenTestResult.id'] = $penTestResult_ids;
			}
			else
			{
				$empty = true;
			}
		}
		
		if(!$empty)
		{
			$results = $this->scopedResults($scope, $conditions);
		}
		
		// try to figure out how they're crossing over
		$seenResults = array();
		foreach($results as $resultId => $result)
		{
			foreach($result['PenTestResults'] as $myResult_id => $myResult)
			{
				if(!isset($seenResults[$myResult_id]))
					$seenResults[$myResult_id] = array();
				$seenResults[$myResult_id][$resultId] = $result;
			}
		}
		
		foreach($seenResults as $seenResult_id => $relatedScopeResults)
		{
			if(count($relatedScopeResults) < 2)
			{
				unset($seenResults[$seenResult_id]);
			}
		}
		
		$results = $this->PenTestResult->find('all', array(
			'conditions' => array(
				'PenTestResult.id' => array_keys($seenResults),
			),
		));
		
		foreach($results as $i => $result)
		{
			$result_id = $result['PenTestResult']['id'];
			$results[$i]['crossovers'] = $seenResults[$result_id];
		}
		
		$this->set(compact(array(
			'as_block', 'results', 'reports_event_id',
		)));
//		$this->layout = 'Utilities.ajax_nodebug';
	}
	
	public function db_tab_change($timeAgo = false, $attrKey = false)
	{
		if(!$timeAgo)
			$timeAgo = '-10 minutes';
		if(!$attrKey)
			$attrKey = 'status';
		$timeAgo = date('Y-m-d H:i:s', strtotime($timeAgo));
		$conditions = ['PenTestResult.'.$attrKey.'_date > ' => $timeAgo];
		$conditions = array_merge($conditions, $this->conditions);
		
		$this->conditions = $conditions;
		$this->paginate['order'] = ['PenTestResult.'.$attrKey.'_date' => 'ASC'];
		$this->set('stripped', true);
		return $this->db_tab_index(true);
	}
	
	public function dashboard($reports_event_id = false)
	{
		if($reports_event_id !== false)
			$this->PenTestResult->setDbEventId($reports_event_id);
		
		$reports_event_id = $this->PenTestResult->getDbEventId();
		
		$reportsEvents = $this->PenTestResult->PenTestReport->ReportsEvent->find('list');
		$this->set(compact('reportsEvents', 'reports_event_id'));
		
	}
	
	public function search_results()
	{
		return $this->index();
	}
	
	public function index() 
	{
		$this->Prg->commonProcess();
		
		$conditions = array();
		if(isset($this->passedArgs['reports_status_id']) and $this->passedArgs['reports_status_id'])
			$conditions['PenTestResult.reports_status_id'] = $this->passedArgs['reports_status_id'];
		$conditions = array_merge($conditions, $this->conditions);
		
		if(isset($conditions['OR']) and !$conditions['OR'] and !in_array($this->action, array('index', 'admin_index')))
		{
			$this->paginate['empty'] = true;
		}
		
		$page_subtitle = (isset($this->viewVars['page_subtitle'])?$this->viewVars['page_subtitle']:__('All'));
		$page_description = (isset($this->viewVars['page_description'])?$this->viewVars['page_description']:'');
		
		$reportsOrganizations = $this->PenTestResult->ReportsOrganization->typeFormList();
		$reportsSeverities = $this->PenTestResult->ReportsSeverity->typeFormList();
		$reportsRemediations = $this->PenTestResult->ReportsRemediation->typeFormList();
		$reportsVerifications = $this->PenTestResult->ReportsVerification->typeFormList();
		$reportsStatuses = $this->PenTestResult->ReportsStatus->typeFormList();
		$reportsAssignableParties = $this->PenTestResult->ReportsAssignableParty->typeFormList();
		$eolSoftwares = $this->PenTestResult->EolSoftware->typeFormList();
		$multiselectOptions = $this->PenTestResult->multiselectOptions(false, true);
		$fismaSystems = $this->PenTestResult->FismaSystem->typeFormList();
		$this->set(compact(array('reportsOrganizations', 'reportsSeverities', 'reportsVerifications', 
			'reportsRemediations', 'reportsStatuses', 'reportsAssignableParties', 'eolSoftwares', 
			'multiselectOptions', 
			'fismaSystems'
		)));
		
		if(isset($this->passedArgs['field']) and isset($this->passedArgs['value'])) 
		{
			$field = $this->passedArgs['field'];
			if(strpos($field, '.') === false)
				$field = 'PenTestResult.'. $field;
			$conditions[$field] = $this->passedArgs['value'];
			
			if($this->passedArgs['field'] == 'reports_remediation_id' and isset($reportsRemediations[$this->passedArgs['value']]))
			{
				$reportsRemediation = $this->PenTestResult->ReportsRemediation->read(null, $this->passedArgs['value']);
				$page_subtitle = __('By %s: %s', __('Remediation'), $reportsRemediation['ReportsRemediation']['name']);
				$page_description = $reportsRemediation['ReportsRemediation']['details'];
			}
			
			if($this->passedArgs['field'] == 'reports_verification_id' and isset($reportsVerifications[$this->passedArgs['value']]))
			{
				$reportsVerification = $this->PenTestResult->ReportsVerification->read(null, $this->passedArgs['value']);
				$page_subtitle = __('By %s: %s', __('Verification'), $reportsVerification['ReportsVerification']['name']);
				$page_description = $reportsVerification['ReportsVerification']['details'];
			}
			
			if($this->passedArgs['field'] == 'reports_status_id' and isset($reportsStatuses[$this->passedArgs['value']]))
			{
				$reportsStatus = $this->PenTestResult->ReportsStatus->read(null, $this->passedArgs['value']);
				$page_subtitle = __('By %s: %s', __('Status'), $reportsStatus['ReportsStatus']['name']);
				$page_description = $reportsStatus['ReportsStatus']['details'];
			}
			
			if($this->passedArgs['field'] == 'reports_severity_id' and isset($reportsSeverities[$this->passedArgs['value']]))
			{
				$reportsSeverity = $this->PenTestResult->ReportsSeverity->read(null, $this->passedArgs['value']);
				$page_subtitle = __('By %s: %s', __('Severity'), $reportsSeverity['ReportsSeverity']['name']);
				$page_description = $reportsSeverity['ReportsSeverity']['details'];
			}
			
			if($this->passedArgs['field'] == 'reports_assignable_party_id' and isset($reportsAssignableParties[$this->passedArgs['value']]))
			{
				$reportsAssignableParty = $this->PenTestResult->ReportsAssignableParty->read(null, $this->passedArgs['value']);
				$page_subtitle = __('By %s: %s', __('Assignable Party'), $reportsAssignableParty['ReportsAssignableParty']['name']);
				$page_description = $reportsAssignableParty['ReportsAssignableParty']['details'];
			}
		}
		
		$this->paginate['conditions'] = $this->PenTestResult->conditions($conditions, $this->passedArgs); 
		if(isset($this->request->params['ext']) and $this->request->params['ext'] === 'csv')
		{
			$this->paginate['limit'] = $this->paginate['maxLimit'] = $this->PenTestResult->getCachedCounts('count', array('conditions' => $this->paginate['conditions']));
			if(!$this->paginate['limit'])
				$this->paginate['empty'] = true;
			$this->layout = 'Utilities.../ajax_nodebug';
		}
		
		if(!isset($this->paginateModel))
			$this->paginateModel = 'PenTestResult';
		
		$this->paginate['contain'] = array(
			'EolSoftware', 'FismaSystem',
			'ReportsAssignableParty', 'ReportsOrganization', 'ReportsRemediation', 'ReportsSeverity', 'ReportsStatus', 'ReportsVerification',
		);
		
		$pen_test_results = $this->paginate($this->paginateModel);
		
		foreach($pen_test_results as $i => $pen_test_result)
		{
			$pen_test_results[$i] = $this->PenTestResult->attachFismaSystem($pen_test_result, true);
		}
		
		$this->set('pen_test_results', $pen_test_results);
		
		$this->set(compact(array('page_subtitle', 'page_description')));
	}
	
	public function index_fisma_systems() 
	{
		$conditions = array();
		
		$page_subtitle = __('All results with a %s', ('FISMA System'));
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->index();
	}
	
	public function orphans() 
	{
		$conditions = $this->PenTestResult->orphanConditions(); 
		
		$page_subtitle = __('Not found in any current %s', __('FISMA System'), __('Inventories'));
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function multiple_fisma_systems()
	{
		$conditions = $this->PenTestResult->conditionsforMultipleFismaSystems();
		
		$page_subtitle = __('Found in multiple %s', __('FISMA Systems'));
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function overridden()
	{
		$conditions = array(
			'PenTestResult.fisma_system_id !=' => 0,
		);
		
		$page_subtitle = __('Results that have been Overridden');
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function isso_open($reports_event_id = false)
	{
		$openId = $this->PenTestResult->ReportsStatus->getOpenId();
		
		$conditions = [
			'PenTestResult.reports_status_id' => $openId
		];
		
		// get the result ids for this event
		if($reports_event_id)
		{
			$penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id);
			$conditions['PenTestResult.id'] = $penTestResult_ids;
		}
		
		$this->PenTestResult->includeCounts = false;
		
		$page_subtitle = __('Open Individual Results');
		$page_description = '';
		$no_options = true;
		$this->set(compact(['page_title', 'page_subtitle', 'page_description', 'no_options']));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function isso_open_counts($reports_event_id = false)
	{
		$openId = $this->PenTestResult->ReportsStatus->getOpenId();
		
		$conditions = [
			'PenTestResult.reports_status_id' => $openId
		];
		
		// get the result ids for this event
		if($reports_event_id)
		{
			$penTestResult_ids = $this->PenTestResult->getIdsForEvent($reports_event_id);
			$conditions['PenTestResult.id'] = $penTestResult_ids;
		}
		
		$this->PenTestResult->includeCounts = false;
		$results = $this->PenTestResult->find('all', [
			'conditions' => $conditions,
		]);
		
		foreach($results as $i => $result)
		{
			$results[$i] = $this->PenTestResult->attachFismaSystem($result);
		}
		
		$reportsEvents = $this->PenTestResult->PenTestReport->ReportsEvent->find('list');
		
		$this->set(compact(['results', 'reportsEvents', 'reports_event_id']));
	}
	
	public function reports_event($id = null) 
	{
		if (!$reportsEvent = $this->PenTestResult->PenTestReport->ReportsEvent->read(null, $id))
		{
			throw new NotFoundException(__('Invalid %s', __('Reports Event')));
		}
		$this->set('reportsEvent', $reportsEvent);
		
/*
		$penTestReport_ids = $this->PenTestResult->PenTestReport->find('list', array(
			'conditions' => array(
				'PenTestReport.reports_event_id' => $id,
			),
			'fields' => array('PenTestReport.id', 'PenTestReport.id'),
		));
		
		$penTestResult_ids = $this->PenTestResult->PenTestReportPenTestResult->find('list', array(
			'conditions' => array(
				'PenTestReportPenTestResult.pen_test_report_id' => $penTestReport_ids,
			),
			'fields' => array('PenTestReportPenTestResult.pen_test_result_id', 'PenTestReportPenTestResult.pen_test_result_id'),
		));
		
		$conditions = array(
			'PenTestResult.id' => $penTestResult_ids,
		);
*/
		
		if(!$conditions = $this->PenTestResult->PenTestReportPenTestResult->getResultIdsForEvent($id))
		{
			$this->paginate['empty'] = true;
		}
		
		$page_subtitle = __('%s: %s', __('Reports Event'), $reportsEvent['ReportsEvent']['name']);
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function pen_test_report($id = null) 
	{
		if (!$pen_test_report = $this->PenTestResult->PenTestReport->read(null, $id))
		{
			throw new NotFoundException(__('Invalid %s', __('Pen Test Report')));
		}
		$this->set('pen_test_report', $pen_test_report);
		
		$penTestResult_ids = $this->PenTestResult->PenTestReportPenTestResult->find('list', array(
			'conditions' => array(
				'PenTestReportPenTestResult.pen_test_report_id' => $id,
			),
			'fields' => array('PenTestReportPenTestResult.pen_test_result_id', 'PenTestReportPenTestResult.pen_test_result_id'),
		));
		
		$conditions = array(
			'PenTestResult.id' => $penTestResult_ids,
		);
		
		$page_subtitle = __('%s: %s', __('Pen Test Report'), $pen_test_report['PenTestReport']['name']);
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function fisma_software($id = null) 
	{
		if (!$fisma_software = $this->PenTestResult->FismaSoftware->read(null, $id))
		{
			throw new NotFoundException(__('Invalid %s', __('Whitelisted Software')));
		}
		$this->set('fisma_software', $fisma_software);
		
		$page_subtitle = __('All');
		$page_description = '';
		
		$conditions = array(
			'PenTestResult.fisma_software_id' => $id,
		);
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function eol_software($id = null) 
	{
		if (!$eol_software = $this->PenTestResult->EolSoftware->read(null, $id))
		{
			throw new NotFoundException(__('Invalid %s', __('EOL/US Software')));
		}
		$this->set('eol_software', $eol_software);
		
		$page_subtitle = __('All');
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$conditions = array(
			'PenTestResult.eol_software_id' => $id,
		); 
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function org($org_id = null, $stripped = false)  
	{
		if (!$org_id) 
		{
			throw new NotFoundException(__('Invalid %s', __('ORG/IC')));
		}
		
		$org = $this->PenTestResult->FismaSystem->OwnerContact->Sac->Branch->Division->Org->find('first', array(
			'conditions' => array('Org.id' => $org_id),
		));
		if (!$org) 
		{
			throw new NotFoundException(__('Invalid %s', __('ORG/IC')));
		}
		$this->set('object', $org);
		
		$conditions = $this->PenTestResult->scopedResults('org', array(), array('conditions' => array('Org.id' => $org_id)), true);
		$conditions = array_merge($conditions, $this->conditions);
		
		if(!isset($conditions['OR']) or !$conditions['OR'])
			$this->paginate['empty'] = true;
		
		$this->conditions = $conditions;
		$this->set('stripped', $stripped);
		
		if($stripped)
			return $this->db_tab_index($stripped);
		else
			return $this->index();
	}
	
	public function division($division_id = null, $stripped = false)  
	{
		if (!$division_id) 
		{
			throw new NotFoundException(__('Invalid %s', __('Division')));
		}
		
		$division = $this->PenTestResult->FismaSystem->OwnerContact->Sac->Branch->Division->find('first', array(
			'conditions' => array('Division.id' => $division_id),
			'contain' => array('Org'),
		));
		if (!$division) 
		{
			throw new NotFoundException(__('Invalid %s', __('Division')));
		}
		$this->set('object', $division);
		
		$conditions = $this->PenTestResult->scopedResults('division', array(), array('conditions' => array('Division.id' => $division_id)), true);
		$conditions = array_merge($conditions, $this->conditions);
		if(!$conditions['OR'])
			$this->paginate['empty'] = true;
		
		$this->conditions = $conditions;
		$this->set('stripped', $stripped);
		
		if($stripped)
			return $this->db_tab_index($stripped);
		else
			return $this->index();
	}
	
	public function branch($branch_id = null, $stripped = false)  
	{
		if (!$branch_id) 
		{
			throw new NotFoundException(__('Invalid %s', __('Branch')));
		}
		
		$branch = $this->PenTestResult->FismaSystem->OwnerContact->Sac->Branch->find('first', array(
			'conditions' => array('Branch.id' => $branch_id),
			'contain' => array('Division', 'Division.Org'),
		));
		if (!$branch) 
		{
			throw new NotFoundException(__('Invalid %s', __('Branch')));
		}
		$this->set('object', $branch);
		
		$conditions = $this->PenTestResult->scopedResults('branch', array(), array('conditions' => array('Branch.id' => $branch_id)), true);
		$conditions = array_merge($conditions, $this->conditions);
		if(!$conditions['OR'])
			$this->paginate['empty'] = true;
		
		$this->conditions = $conditions;
		$this->set('stripped', $stripped);
		
		if($stripped)
			return $this->db_tab_index($stripped);
		else
			return $this->index();
	}
	
	public function sac($sac_id = null, $stripped = false)  
	{
		if (!$sac_id) 
		{
			throw new NotFoundException(__('Invalid %s', __('SAC')));
		}
		
		$sac = $this->PenTestResult->FismaSystem->OwnerContact->Sac->find('first', array(
			'conditions' => array('Sac.id' => $sac_id),
			'contain' => array('Branch', 'Branch.Division', 'Branch.Division.Org'),
		));
		if (!$sac) 
		{
			throw new NotFoundException(__('Invalid %s', __('SAC')));
		}
		$this->set('object', $sac);
		
		$conditions = $this->PenTestResult->scopedResults('sac', array(), array('conditions' => array('Sac.id' => $sac_id)), true);
		$conditions = array_merge($conditions, $this->conditions);
		if(!$conditions['OR'])
			$this->paginate['empty'] = true;
		
		$this->conditions = $conditions;
		$this->set('stripped', $stripped);
		
		if($stripped)
			return $this->db_tab_index($stripped);
		else
			return $this->index();
	}
	
	public function owner($owner_id = false, $stripped = false)
	{
		if (!$owner_id) 
		{
			throw new NotFoundException(__('Invalid %s', __('Contact')));
		}
		
		$ownerContact = $this->PenTestResult->FismaSystem->OwnerContact->find('first', array(
			'conditions' => array('OwnerContact.id' => $owner_id),
			'contain' => array('Sac', 'Sac.Branch', 'Sac.Branch.Division', 'Sac.Branch.Division.Org'),
		));
		$ownerContact['AdAccount'] = $ownerContact['OwnerContact'];
		if (!$ownerContact) 
		{
			throw new NotFoundException(__('Invalid %s', __('Contact')));
		}
		$this->set('object', $ownerContact);
		
		$conditions = $this->PenTestResult->scopedResults('owner', array(), array('conditions' => array('OwnerContact.id' => $owner_id)), true);
		$conditions = array_merge($conditions, $this->conditions);
		if(!$conditions['OR'])
			$this->paginate['empty'] = true;
		
		$this->conditions = $conditions;
		$this->set('stripped', $stripped);
		
		if($stripped)
			return $this->db_tab_index($stripped);
		else
			return $this->index();
	}
	
	public function crm($crm_id = false, $stripped = false)
	{
		if (!$crm_id) 
		{
			throw new NotFoundException(__('Invalid %s', __('CRM')));
		}
		
		$crm = $this->PenTestResult->FismaSystem->OwnerContact->find('first', array(
			'conditions' => array('OwnerContact.id' => $crm_id),
			'contain' => array('Sac', 'Sac.Branch', 'Sac.Branch.Division', 'Sac.Branch.Division.Org'),
		));
		$crm['AdAccount'] = $crm['OwnerContact'];
		if (!$crm) 
		{
			throw new NotFoundException(__('Invalid %s', __('CRM')));
		}
		$this->set('object', $crm);
		
		$conditions = array('OR' => array());
		if($fismaSystem_ids = $this->PenTestResult->FismaSystem->idsForCrm($crm_id))
		{
			$conditions = $this->PenTestResult->scopedResults('crm', array(), array(
				'conditions' => array('FismaSystem.id' => $fismaSystem_ids)
			), true);
			$conditions = array_merge($conditions, $this->conditions);
		}
		
		if(!$conditions['OR'])
			$this->paginate['empty'] = true;
		
		$this->conditions = $conditions;
		$this->set('stripped', $stripped);
		
		if($stripped)
			return $this->db_tab_index($stripped);
		else
			return $this->index();
	}
	
	public function fisma_system($id = null, $reports_status_id = false, $reports_severity_id = false, $stripped = false) 
	{
		if (!$fisma_system = $this->PenTestResult->FismaSystem->read(null, $id))
		{
			throw new NotFoundException(__('Invalid %s', __('FISMA System')));
		}
		$this->set('fisma_system', $fisma_system);
		
		$page_subtitle = __('All Results for %s: %s', __('FISMA System'), $fisma_system['FismaSystem']['name']);
		$page_description = '';
		
		$conditions = array();
			
		if($reports_status_id)
		{
			$reportsStatus = $this->PenTestResult->ReportsStatus->read(null, $reports_status_id);
			$page_subtitle = __('Results for %s: %s - with %s: %s', __('FISMA System'), $fisma_system['FismaSystem']['name'], __('Status'), $reportsStatus['ReportsStatus']['name']);
			$conditions['PenTestResult.reports_status_id'] = $reports_status_id;
		} 
		
		if($reports_severity_id)
		{
			$conditions['PenTestResult.reports_severity_id'] = $reports_severity_id;
		}
		
		$reports_event_id = false;
		if(isset($this->passedArgs['reports_event_id']))
		{
			$reports_event_id = $this->passedArgs['reports_event_id'];
		}
		
		$this->PenTestResult->includeCounts = false;
		if(!$scopedConditions = $this->PenTestResult->conditionsforFismaSystem($id))
		{
			$this->paginate['empty'] = true;
		}
		
		$conditions = array_merge($conditions, $scopedConditions);
		
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->set('stripped', $stripped);
		
		if($stripped)
			return $this->db_tab_index($stripped, $reports_event_id);
		else
			return $this->index();
	}
	
	public function fisma_inventory($id = null) 
	{
		if (!$fisma_inventory = $this->PenTestResult->SubnetMember->FismaInventory->read(null, $id))
		{
			throw new NotFoundException(__('Invalid %s', __('FISMA Inventory')));
		}
		$this->set('fisma_inventory', $fisma_inventory);
		
		$conditions = $this->PenTestResult->conditionsforInventory($fisma_inventory);
		if(!isset($conditions['OR']))
			$this->paginate['empty'] = true;
		
		$fisma_inventory_name = $fisma_inventory['FismaInventory']['name'];
		if(!$fisma_inventory_name)
			$fisma_inventory_name = $fisma_inventory['FismaInventory']['asset_tag'];
		if(!$fisma_inventory_name)
			$fisma_inventory_name = $fisma_inventory['FismaInventory']['ip_address'];
		
		$page_subtitle = __('%s: %s', __('FISMA Inventory'), $fisma_inventory_name);
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function fov_result($id = null) 
	{
		if (!$fov_result = $this->PenTestResult->FismaSystem->FovResult->read(null, $id))
		{
			throw new NotFoundException(__('Invalid %s', __('FOV Result')));
		}
		$this->set('fov_result', $fov_result);
		
		$conditions = $this->PenTestResult->conditionsforResult('FovResult', $fov_result);
		$result_name = $this->PenTestResult->nameForResult('FovResult', $fov_result);
		
		$page_subtitle = __('%s: %s', __('FOV Result'), $result_name);
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function us_result($id = null) 
	{
		if (!$us_result = $this->PenTestResult->SubnetMember->UsResult->read(null, $id))
		{
			throw new NotFoundException(__('Invalid %s', __('US Result')));
		}
		$this->set('us_result', $us_result);
		
		$conditions = $this->PenTestResult->conditionsforResult('UsResult', $us_result);
		$result_name = $this->PenTestResult->nameForResult('UsResult', $us_result);
		
		$page_subtitle = __('%s: %s', __('US Result'), $result_name);
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function eol_result($id = null) 
	{
		if (!$eol_result = $this->PenTestResult->SubnetMember->EolResult->read(null, $id))
		{
			throw new NotFoundException(__('Invalid %s', __('EOL Result')));
		}
		$this->set('eol_result', $eol_result);
		
		$conditions = $this->PenTestResult->conditionsforResult('EolResult', $eol_result);
		$result_name = $this->PenTestResult->nameForResult('EolResult', $eol_result);
		
		$page_subtitle = __('%s: %s', __('EOL Result'), $result_name);
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function pen_test_result($id = null) 
	{
		if (!$pen_test_result = $this->PenTestResult->read(null, $id))
		{
			throw new NotFoundException(__('Invalid %s', __('Pen Test Result')));
		}
		$this->set('pen_test_result', $pen_test_result);
		
		$conditions = $this->PenTestResult->conditionsforResult('PenTestResult', $pen_test_result);
		$result_name = $this->PenTestResult->nameForResult('PenTestResult', $pen_test_result);
		
		$page_subtitle = __('%s: %s', __('Pen Test Result'), $result_name);
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function high_risk_result($id = null) 
	{
		if (!$high_risk_result = $this->PenTestResult->SubnetMember->HighRiskResult->read(null, $id))
		{
			throw new NotFoundException(__('Invalid %s', __('High Risk Result')));
		}
		$this->set('high_risk_result', $high_risk_result);
		
		$conditions = $this->PenTestResult->conditionsforResult('HighRiskResult', $high_risk_result);
		$result_name = $this->PenTestResult->nameForResult('HighRiskResult', $high_risk_result);
		
		$page_subtitle = __('%s: %s', __('High Risk Result'), $result_name);
		$page_description = '';
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function tag($tag_id = null) 
	{
		if(!$tag_id) 
		{
			throw new NotFoundException(__('Invalid %s', __('Tag')));
		}
		
		$tag = $this->PenTestResult->Tag->read(null, $tag_id);
		if(!$tag) 
		{
			throw new NotFoundException(__('Invalid %s', __('Tag')));
		}
		$this->set('tag', $tag);
		
		$page_subtitle = __('All');
		$page_description = '';
		
		$conditions = array();
		
		$conditions[] = $this->PenTestResult->Tag->Tagged->taggedSql($tag['Tag']['keyname'], 'PenTestResult');
		$this->set(compact(array('page_subtitle', 'page_description')));
		
		$this->conditions = $conditions;
		$this->index(); 
	}
	
	public function view($id = false)
	{
		$this->PenTestResult->id = $id;
		$this->PenTestResult->recursive = 0;
		if (!$pen_test_result = $this->PenTestResult->read(null, $id))
		{
			throw new NotFoundException(__('Invalid %s', __('Pen Test Result')));
		}
		
		$pen_test_result = $this->PenTestResult->attachFismaSystem($pen_test_result);
			
		$this->set('pen_test_result', $pen_test_result);
	}
	
	public function edit($id = null)
	{
		$this->PenTestResult->id = $id;
		$this->PenTestResult->recursive = 1;
		$this->PenTestResult->contain(array('Tag', 'ReportsSeverity', 'ReportsOrganization'));
		if (!$pen_test_result = $this->PenTestResult->read(null, $id)) 
		{
			throw new NotFoundException(__('Invalid %s', __('Pen Test Result')));
		}
		
		if ($this->request->is('post') || $this->request->is('put')) 
		{
			$this->request->data['PenTestResult']['modified_user_id'] = AuthComponent::user('id');
			if ($this->PenTestResult->save($this->request->data)) 
			{
				$this->Flash->success(__('The %s has been saved', __('Pen Test Result')));
				return $this->redirect(array('action' => 'view', $this->PenTestResult->id));
			}
			else
			{
				$this->Flash->error(__('The %s could not be saved. Please, try again.', __('Pen Test Result')));
			}
		}
		else
		{
			$this->request->data = $pen_test_result;
		}
		
		
		$reportsOrganizations = $this->PenTestResult->ReportsOrganization->typeFormListBlank();
		$reportsSeverities = $this->PenTestResult->ReportsSeverity->typeFormListBlank();
		$reportsRemediations = $this->PenTestResult->ReportsRemediation->typeFormListBlank();
		$reportsVerifications = $this->PenTestResult->ReportsVerification->typeFormListBlank();
		$reportsStatuses = $this->PenTestResult->ReportsStatus->typeFormListBlank();
		$reportsAssignableParties = $this->PenTestResult->ReportsAssignableParty->typeFormListBlank();
		$eolSoftwares = $this->PenTestResult->EolSoftware->typeFormList();
		$fismaSystems = $this->PenTestResult->FismaSystem->typeFormList();
		$this->set(compact(array(
			'reportsOrganizations', 'reportsSeverities', 'reportsVerifications', 
			'reportsRemediations', 'reportsStatuses', 'reportsAssignableParties',
			'eolSoftwares', 'fismaSystems'
		)));
	}

	public function admin_index() 
	{
		$this->bypassReferer = true;
		return $this->redirect(array('action' => 'index', 'admin' => false));
	}
	
	public function admin_view($id = false)
	{
		$this->bypassReferer = true;
		return $this->redirect(array('action' => 'view', $id, 'admin' => false));
	}
	
	public function admin_delete($id = null) 
	{
		$this->PenTestResult->id = $id;
		if (!$this->PenTestResult->exists()) {
			throw new NotFoundException(__('Invalid %s', __('Pen Test Result')));
		}
		if ($this->PenTestResult->delete()) {
			$this->Flash->success(__('%s deleted', __('Pen Test Result')));
			return $this->redirect(array('action' => 'index', 'admin' => false));
		}
		$this->Flash->error(__('%s was not deleted', __('Pen Test Result')));
		return $this->redirect(array('action' => 'index', 'admin' => false));
	}
}